# Story 1.7: Compliance Dashboard and Reporting

## Status
Approved

## Story
**As a** builder admin,
**I want** comprehensive SWMS tracking and Work Safe compliance reports,
**so that** I can quickly demonstrate compliance during inspections and audits.

## Acceptance Criteria
1. Create real-time SWMS dashboard integrated into job site pages
2. Implement visual progress indicators and status tracking
3. Build one-click Work Safe compliance export functionality
4. Create comprehensive audit trails and compliance documentation
5. Implement quick action buttons for campaign management

## Tasks / Subtasks

- [ ] Task 1: Create real-time SWMS dashboard integration (AC: 1)
  - [ ] Subtask 1.1: Extend existing job site detail pages with SWMS dashboard section
  - [ ] Subtask 1.2: Create SwmsDashboard component following existing Card component patterns
  - [ ] Subtask 1.3: Implement real-time SWMS job status display using Supabase Realtime
  - [ ] Subtask 1.4: Add SWMS metrics to existing admin dashboard KPI cards
  - [ ] Subtask 1.5: Create SWMS overview section in main admin dashboard following existing patterns

- [ ] Task 2: Implement visual progress indicators and status tracking (AC: 2)  
  - [ ] Subtask 2.1: Create SwmsProgressIndicator component using existing UI patterns
  - [ ] Subtask 2.2: Implement contractor submission status badges following existing badge patterns
  - [ ] Subtask 2.3: Create SWMS job completion percentage calculations
  - [ ] Subtask 2.4: Add visual status tracking for email campaign progress
  - [ ] Subtask 2.5: Implement SWMS timeline view showing submission history

- [ ] Task 3: Build Work Safe compliance export functionality (AC: 3)
  - [ ] Subtask 3.1: Create work-safe-export Edge Function following existing Edge Function patterns
  - [ ] Subtask 3.2: Implement PDF generation for compliance reports using existing document patterns
  - [ ] Subtask 3.3: Create compliance data aggregation queries for export
  - [ ] Subtask 3.4: Add one-click export button to SWMS dashboard interface
  - [ ] Subtask 3.5: Implement secure download links with signed URLs following existing storage patterns

- [ ] Task 4: Create comprehensive audit trails and compliance documentation (AC: 4)
  - [ ] Subtask 4.1: Extend existing audit logging to capture all SWMS actions
  - [ ] Subtask 4.2: Create SWMS compliance timeline view showing all contractor interactions
  - [ ] Subtask 4.3: Implement compliance document storage following existing file storage patterns
  - [ ] Subtask 4.4: Add audit trail export functionality for compliance reviews
  - [ ] Subtask 4.5: Create compliance documentation templates and automated generation

- [ ] Task 5: Implement quick action buttons for campaign management (AC: 5)
  - [ ] Subtask 5.1: Add campaign action buttons to SWMS dashboard interface
  - [ ] Subtask 5.2: Implement send reminder functionality connecting to email automation from Story 1.6
  - [ ] Subtask 5.3: Create bulk actions for multiple contractors following existing patterns
  - [ ] Subtask 5.4: Add campaign status override controls for admin users
  - [ ] Subtask 5.5: Implement campaign completion actions and notifications

- [ ] Task 6: Testing and validation (AC: All)
  - [ ] Subtask 6.1: Write unit tests for all dashboard components using Jest + React Testing Library
  - [ ] Subtask 6.2: Test compliance export functionality with realistic SWMS data
  - [ ] Subtask 6.3: Test real-time dashboard updates and status indicators
  - [ ] Subtask 6.4: Verify audit trail completeness and accuracy
  - [ ] Subtask 6.5: Test campaign management actions and integrations
  - [ ] Subtask 6.6: Performance test dashboard with large contractor datasets

## Dev Notes

### Previous Story Dependencies & Prerequisites
**Database Foundation Status (from Stories 1.1-1.6):**
- **REQUIRED**: Contractors table from Story 1.1 (company records and hierarchical data)
- **REQUIRED**: SWMS database structure from Story 1.3 (swms_jobs, swms_submissions tables)  
- **REQUIRED**: Contractor portal from Story 1.4 (submission data and status tracking)
- **REQUIRED**: SWMS job site management from Story 1.5 (job site integration and metrics)
- **REQUIRED**: Email automation system from Story 1.6 (campaign tracking and status data)
- **Integration**: Dashboard will aggregate data from all previous stories' database tables
- **Status**: All previous stories provide the foundation data structures for comprehensive reporting

**Existing Dashboard Infrastructure Status:**
- **Available**: Admin dashboard framework at `/admin/` with existing KPI card patterns
- **Available**: Dashboard types in `src/types/dashboard.ts` with extensible metrics interfaces
- **Available**: Card components and layout patterns using Shadcn/ui
- **Available**: Real-time capabilities via Supabase Realtime subscriptions
- **Integration**: Extend existing dashboard rather than creating separate SWMS dashboard

### Data Models [Source: architecture/tech-stack.md#swms-enhancement-tables + existing dashboard patterns]

**SWMS Dashboard Data Aggregation:**
```typescript
// Extended dashboard metrics including SWMS data
interface SwmsDashboardMetrics {
  // Existing metrics from dashboard.ts
  activeWorkers: number
  recentCheckIns: number
  upcomingExpirations: number
  
  // New SWMS metrics
  activeSwmsJobs: number
  pendingSubmissions: number
  overdueSub missions: number
  complianceRate: number
  activeCampaigns: number
}

// SWMS job status aggregation
interface SwmsJobStatus {
  id: string
  job_site: {
    name: string
    id: string
  }
  contractor_count: number
  submitted_count: number
  pending_count: number
  overdue_count: number
  completion_percentage: number
  last_activity: string
  campaign_status: 'active' | 'completed' | 'pending'
}

// Work Safe compliance export data structure
interface ComplianceExportData {
  job_site_id: string
  job_site_name: string
  contractors: {
    id: string
    company_name: string
    abn: string
    submission_date: string | null
    document_url: string | null
    status: 'submitted' | 'pending' | 'overdue'
  }[]
  export_date: string
  compliance_rate: number
  audit_trail: {
    action: string
    timestamp: string
    user: string
    details: string
  }[]
}
```

**Integration with Existing Dashboard Tables:**
- Extends existing `dashboard.ts` metrics interface
- Links to `swms_jobs` table from Story 1.3 via job_site_id
- Links to `swms_submissions` table for contractor submission status
- Uses `swms_email_campaigns` from Story 1.6 for campaign status tracking
- Integrates with existing `job_sites` table for site information

### File Locations [Source: architecture/source-tree.md#existing-admin-structure + SWMS extensions]

**Dashboard Component Extensions:**
- **Main Dashboard**: Extend existing `apps/web/src/app/admin/page.tsx`
- **SWMS Dashboard Component**: `apps/web/src/components/admin/SwmsDashboard.tsx`
- **Progress Indicators**: `apps/web/src/components/swms/SwmsProgressIndicator.tsx`
- **Compliance Export**: `apps/web/src/components/swms/ComplianceExport.tsx`
- **Campaign Actions**: `apps/web/src/components/swms/SwmsCampaignActions.tsx`

**Job Site Integration Pages:**
- **SWMS Dashboard Section**: Extend existing `apps/web/src/app/admin/job-sites/[id]/page.tsx`
- **SWMS Overview**: `apps/web/src/app/admin/job-sites/[id]/swms/page.tsx`
- **SWMS Actions**: `apps/web/src/app/admin/job-sites/[id]/swms/actions.ts`

**New Edge Functions:**
- **Compliance Export**: `supabase/functions/work-safe-export/index.ts`
- **Dashboard Aggregation**: `supabase/functions/swms-dashboard-data/index.ts`
- **Campaign Actions**: `supabase/functions/swms-campaign-actions/index.ts`

**Type Extensions:**
- **Extended Dashboard Types**: Extend `apps/web/src/types/dashboard.ts`
- **SWMS Dashboard Types**: `apps/web/src/types/swms-dashboard.ts`
- **Compliance Types**: `apps/web/src/types/compliance.ts` (already exists)

### API Integration Points [Source: architecture/tech-stack.md#api-patterns + existing admin API patterns]

**Dashboard API Extensions [Source: existing `/api/admin/` patterns]:**
```typescript
// Extend existing admin API patterns
interface SwmsDashboardAPI {
  // Dashboard metrics endpoint
  'GET /api/admin/dashboard/swms-metrics': {
    response: SwmsDashboardMetrics
  }
  
  // Job site SWMS status endpoint
  'GET /api/admin/job-sites/[id]/swms-status': {
    response: SwmsJobStatus
  }
  
  // Compliance export endpoint
  'POST /api/admin/compliance/export': {
    body: { job_site_ids: string[], format: 'pdf' | 'csv' }
    response: { download_url: string, expires_at: string }
  }
  
  // Campaign action endpoints
  'POST /api/admin/swms-campaigns/[id]/actions': {
    body: { action: 'send_reminder' | 'complete' | 'cancel' }
    response: { success: boolean, message: string }
  }
}
```

**Real-time Dashboard Integration [Source: existing Supabase Realtime patterns]:**
```typescript
// Real-time subscriptions for dashboard updates
interface SwmsRealTimeSubscriptions {
  swms_submissions: {
    event: 'INSERT' | 'UPDATE'
    callback: (payload: SwmsSubmission) => void
  }
  swms_email_sends: {
    event: 'UPDATE'
    callback: (payload: SwmsEmailSend) => void
  }
  swms_jobs: {
    event: 'UPDATE'
    callback: (payload: SwmsJob) => void
  }
}

// Dashboard state management
const useSwmsDashboard = () => {
  const [metrics, setMetrics] = useState<SwmsDashboardMetrics>()
  
  useEffect(() => {
    // Subscribe to real-time updates following existing patterns
    const supabase = createClient()
    
    const subscription = supabase
      .channel('swms-dashboard')
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'swms_submissions'
      }, handleSubmissionChange)
      .subscribe()
      
    return () => subscription.unsubscribe()
  }, [])
}
```

### Work Safe Compliance Export Integration [Source: existing file storage + Edge Function patterns]

**Edge Function Pattern [Source: supabase/functions patterns]:**
```typescript
// Work Safe compliance export Edge Function
import { createClient } from 'jsr:@supabase/supabase-js@2'

interface WorkSafeExportRequest {
  job_site_ids: string[]
  format: 'pdf' | 'csv'
  include_audit_trail: boolean
}

interface WorkSafeExportResponse {
  success: boolean
  export_id: string
  download_url?: string
  expires_at?: string
  error?: string
}

Deno.serve(async (req: Request) => {
  try {
    const supabaseUrl = Deno.env.get('SUPABASE_URL')
    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')
    
    const supabase = createClient(supabaseUrl!, supabaseServiceKey!)
    
    // Implementation following existing Edge Function patterns
    // 1. Aggregate SWMS data from all relevant tables
    // 2. Generate compliance report in requested format
    // 3. Store in Supabase Storage with signed URL
    // 4. Return download link with expiry
    
    const exportData = await aggregateComplianceData(jobSiteIds)
    const reportUrl = await generateComplianceReport(exportData, format)
    
    return new Response(JSON.stringify({
      success: true,
      export_id: crypto.randomUUID(),
      download_url: reportUrl,
      expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
    }), {
      headers: { 'Content-Type': 'application/json' },
    })
  } catch (error) {
    // Error handling following existing patterns
  }
})
```

**Compliance Report Generation:**
- PDF generation using existing document patterns
- CSV export for data analysis integration
- Audit trail inclusion with comprehensive logging
- Secure file storage with signed URLs (24-hour expiry)

### UI Component Integration [Source: existing Shadcn/ui patterns + admin dashboard]

**Dashboard Component Extensions [Source: apps/web/src/app/admin/page.tsx patterns]:**
```typescript
// Extend existing admin dashboard with SWMS metrics
interface SwmsKpiCards {
  activeSwmsJobs: KpiCardProps
  pendingSubmissions: KpiCardProps
  complianceRate: KpiCardProps
  activeCampaigns: KpiCardProps
}

// Integration with existing Card component pattern
<Card>
  <CardContent className="p-4">
    <div className="flex items-center">
      <div className="p-2 bg-purple-100 rounded-lg mr-4">
        <FileText className="h-6 w-6 text-purple-600" />
      </div>
      <div>
        <p className="text-sm font-medium text-muted-foreground">SWMS Jobs</p>
        <p className="text-2xl font-bold">{activeSwmsJobs}</p>
        <p className="text-xs text-muted-foreground">Active compliance tracking</p>
      </div>
    </div>
  </CardContent>
</Card>
```

**Job Site Integration Pattern [Source: existing job site management patterns]:**
- Add SWMS dashboard section to existing job site detail pages
- Follow existing layout patterns with Card components
- Integrate with existing job site actions and navigation
- Use existing form patterns for campaign management actions

### Performance Requirements [Source: architecture/tech-stack.md#performance-requirements]

**Dashboard Performance:**
- **Real-time Updates**: Use Supabase Realtime with efficient query patterns
- **Aggregation Queries**: Optimize with database views and indexes
- **Cache Strategy**: Cache dashboard metrics for 5-minute intervals
- **Progressive Loading**: Load critical metrics first, secondary data asynchronously

**Compliance Export Performance:**
- **Processing Time**: Maximum 30 seconds for export generation
- **File Size Limits**: Support up to 1000 contractors per export
- **Storage Efficiency**: Use compressed file formats and cleanup after 24 hours
- **Concurrent Exports**: Queue system for multiple simultaneous export requests

### Authentication & Security [Source: architecture/infrastructure-architecture.md#api-security-architecture]

**Dashboard Security:**
- Use existing admin authentication patterns from current dashboard
- Implement proper RLS policies for SWMS dashboard data access
- Ensure audit logging for all compliance export actions
- Restrict campaign management actions to authorized admin users

**Compliance Export Security:**
```typescript
interface ComplianceExportSecurity {
  access_control: "Admin users only via Supabase Auth JWT validation"
  data_scope: "Only job sites accessible to authenticated admin user"
  audit_logging: "All export actions logged with user ID and timestamp"
  file_security: "Signed URLs with 24-hour expiry, no permanent public access"
  data_sensitivity: "Contains contractor and compliance data - treat as confidential"
}
```

### Integration with Existing Systems [Source: existing admin dashboard and job site patterns]

**Admin Dashboard Integration:**
- Extend existing KPI card grid with SWMS metrics
- Add SWMS activity feed to existing dashboard sections  
- Integrate with existing notification display patterns
- Follow existing color schemes and UI patterns (Shadcn/ui)

**Job Site Management Integration:**
- Add SWMS dashboard section to existing job site detail pages
- Integrate with existing job site action buttons and forms
- Use existing job site navigation and breadcrumb patterns
- Link SWMS data to existing job site metrics and worker data

**Real-time System Integration:**
```typescript
// Integration with existing real-time patterns
const swmsSubscription = supabase
  .channel('admin-dashboard')
  .on('postgres_changes', {
    event: '*',
    schema: 'public', 
    table: 'swms_submissions'
  }, (payload) => {
    // Update dashboard metrics in real-time
    updateDashboardMetrics(payload)
  })
  .on('postgres_changes', {
    event: '*',
    schema: 'public',
    table: 'swms_email_sends'
  }, (payload) => {
    // Update campaign status in real-time
    updateCampaignStatus(payload)
  })
  .subscribe()
```

### Testing Requirements [Source: architecture/coding-standards.md#testing-standards]

**Dashboard Component Testing:**
- **Location**: `apps/web/src/app/admin/__tests__/swms-dashboard.test.tsx`
- **Framework**: Jest + React Testing Library following existing admin test patterns
- **Mock Data**: Use realistic SWMS data structures for testing dashboard rendering
- **Real-time Testing**: Mock Supabase Realtime subscriptions for dashboard updates

**Required Test Categories:**
1. **Dashboard Integration**: Test SWMS metrics display in existing admin dashboard
2. **Progress Indicators**: Test visual status indicators with various completion states
3. **Compliance Export**: Test PDF and CSV export functionality with mock data
4. **Campaign Actions**: Test quick action buttons and campaign management integration
5. **Real-time Updates**: Test dashboard updates when SWMS data changes
6. **Error Handling**: Test graceful degradation when SWMS services are unavailable

**Integration Testing:**
- Test dashboard integration with job site pages
- Test compliance export with full data pipeline from database to PDF
- Test campaign management actions connecting to email automation system
- Performance testing with realistic contractor and job site data volumes (50+ contractors per job)

**Edge Function Testing:**
- **Location**: `supabase/functions/__tests__/work-safe-export.test.ts`
- **Framework**: Deno testing framework with Mock Supabase client
- **Environment**: Test environment variables for document generation
- **File Testing**: Mock PDF generation and storage operations

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-03 | 1.0 | Initial story creation with complete technical context from previous stories and architecture | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514) - Dev Agent

### Debug Log References
*Debug logs and traces will be referenced here*

### Completion Notes List
**Task 1 - Real-time SWMS Dashboard Integration (COMPLETED):**
- ‚úÖ Extended dashboard types with SWMS metrics in `types/dashboard.ts`
- ‚úÖ Created SwmsDashboard component following existing Card patterns  
- ‚úÖ Implemented SwmsProgressIndicator component with visual status tracking
- ‚úÖ Added real-time subscriptions via Supabase Realtime in useSwmsDashboard hook
- ‚úÖ Extended main admin dashboard with SWMS KPI cards 
- ‚úÖ Integrated SWMS dashboard section into job site detail pages as new tab
- ‚úÖ Added comprehensive metrics: activeSwmsJobs, pendingSubmissions, overdueSubmissions, complianceRate
- ‚úÖ Implemented auto-refresh functionality (30-second intervals)
- ‚úÖ Added error handling and loading states
- üîÑ Currently resolving TypeScript issues in tests and hook implementations

### File List
**Created Files:**
- `apps/web/src/components/admin/SwmsDashboard.tsx` - Main SWMS dashboard component
- `apps/web/src/components/swms/SwmsProgressIndicator.tsx` - Visual progress indicators
- `apps/web/src/components/admin/SwmsDashboardWrapper.tsx` - Client-side wrapper with data fetching
- `apps/web/src/hooks/useSwmsDashboard.ts` - Real-time dashboard data hook

**Modified Files:**
- `apps/web/src/types/dashboard.ts` - Extended with SWMS dashboard types
- `apps/web/src/app/admin/page.tsx` - Added SWMS metrics to main dashboard
- `apps/web/src/app/admin/job-sites/[id]/page.tsx` - Integrated SWMS dashboard tab

## QA Results

### Review Date: 2025-01-12

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Quality: Good** - The SWMS dashboard implementation demonstrates solid architectural decisions and follows established patterns. The code is well-structured with appropriate separation of concerns between UI components, data hooks, and type definitions. However, TypeScript compliance issues in tests and incomplete story tasks prevent full completion assessment.

### Refactoring Performed

I performed several critical fixes during the review:

- **File**: `apps/web/src/app/admin/job-sites/__tests__/swms/actions.test.ts`
  - **Change**: Fixed TypeScript compilation errors in test data objects
  - **Why**: Missing required fields `job_site_id` and `status` in `SwmsJobCreateData` test objects were causing compilation failures
  - **How**: Added proper required fields to all test mock data objects (lines 59, 114, 478, 491, 555)

### Compliance Check

- **Coding Standards**: ‚úì **Excellent adherence to established patterns**
  - Components follow existing Shadcn/ui Card patterns consistently
  - Proper TypeScript typing throughout implementation
  - Consistent naming conventions and file organization
  - Good separation of concerns between components and hooks

- **Project Structure**: ‚úì **Follows established architecture**
  - Files properly located according to source tree documentation
  - Components organized in appropriate directories
  - Types properly extended from base dashboard types
  - Integration follows existing admin dashboard patterns

- **Testing Strategy**: ‚ö†Ô∏è **Partial compliance with gaps**
  - Good test coverage for components (13 test files found)
  - Mock data and testing patterns follow Jest + React Testing Library standards
  - **Gap**: TypeScript compilation errors in multiple test files indicate incomplete test refactoring
  - **Gap**: Missing comprehensive integration tests for full dashboard workflow

- **All ACs Met**: ‚ö†Ô∏è **Partial implementation status**
  - **AC1 (Real-time SWMS dashboard)**: ‚úÖ Completed with comprehensive dashboard component
  - **AC2 (Visual progress indicators)**: ‚úÖ Completed with SwmsProgressIndicator component  
  - **AC3 (Work Safe compliance export)**: ‚ùå **Not implemented** - Edge Function and export functionality missing
  - **AC4 (Audit trails and compliance documentation)**: ‚ùå **Not implemented** - Audit system not created
  - **AC5 (Quick action buttons for campaign management)**: ‚ö†Ô∏è **Partially implemented** - UI exists but backend integration incomplete

### Improvements Checklist

**Items I addressed during review:**
- [x] Fixed TypeScript compilation errors in SWMS action tests (actions.test.ts lines 59, 114, 478, 491, 555)
- [x] Verified component architecture follows established patterns
- [x] Confirmed proper type safety implementation
- [x] Validated real-time subscription setup in useSwmsDashboard hook

**Critical items requiring developer attention:**
- [ ] **HIGH PRIORITY**: Complete Work Safe compliance export functionality (AC3) - Missing Edge Function and PDF generation
- [ ] **HIGH PRIORITY**: Implement audit trail system (AC4) - No audit logging mechanism exists
- [ ] **HIGH PRIORITY**: Complete campaign management backend integration (AC5) - Frontend UI exists but actions not connected
- [ ] **MEDIUM PRIORITY**: Fix remaining TypeScript compilation errors in test files (38+ errors across integration tests)
- [ ] **MEDIUM PRIORITY**: Add comprehensive integration tests for full dashboard workflow
- [ ] **LOW PRIORITY**: Add error boundary components for graceful degradation
- [ ] **LOW PRIORITY**: Implement loading states and skeleton UI for better UX

### Security Review

**‚úÖ No security issues identified** in implemented code:
- Proper authentication patterns using existing Supabase Auth
- Row Level Security (RLS) patterns followed for data access
- No exposed sensitive data or credentials
- Secure real-time subscription setup

**‚ö†Ô∏è Pending security validation** for unimplemented features:
- Work Safe compliance export will need secure file generation and signed URL handling
- Audit trail system must properly log user actions without exposing sensitive data

### Performance Considerations

**‚úÖ Performance patterns implemented correctly:**
- Efficient real-time subscriptions with proper cleanup
- Optimized dashboard queries with appropriate data aggregation
- React hooks properly memoized to prevent unnecessary re-renders
- Dashboard auto-refresh with configurable intervals (30-second default)

**‚ö†Ô∏è Performance considerations for completion:**
- Large contractor datasets may need pagination for job status displays
- PDF generation for compliance export should be asynchronous with progress indicators
- Consider implementing client-side caching for dashboard metrics

### Files Modified During Review

**Modified during QA review:**
- `apps/web/src/app/admin/job-sites/__tests__/swms/actions.test.ts` - Fixed TypeScript compilation errors

**Note**: Developer should update File List to reflect any additional changes made during completion.

### Gate Status

**Gate: CONCERNS** ‚Üí docs/qa/gates/1.7-compliance-dashboard-and-reporting.yml

**Primary concerns:**
1. **Incomplete story implementation** - Only 2 of 5 Acceptance Criteria fully completed
2. **TypeScript compilation failures** - 30+ compilation errors across test suite  
3. **Missing critical features** - Work Safe export, audit trails, campaign backend integration

### Recommended Status

**‚ùå Changes Required - See unchecked items above**

**Completion Roadmap:**
1. **Sprint Priority**: Complete AC3 (compliance export), AC4 (audit trails), AC5 (campaign backend)
2. **Technical Debt**: Resolve TypeScript compilation errors in test suite  
3. **Quality Gates**: Add integration tests for full workflow validation
4. **Production Readiness**: Implement error boundaries and comprehensive error handling

**Estimated remaining effort**: 2-3 additional sprint days for core completion + 1 day for test cleanup.

(Story owner decides final status)