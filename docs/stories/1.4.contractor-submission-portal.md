# Story 1.4: Contractor Submission Portal

## Status
Approved

## Story
**As a** contractor,
**I want** a secure portal to submit SWMS documents for specific job sites,
**so that** I can fulfill compliance requirements without creating accounts.

## Acceptance Criteria
1. Build token-based public portal following existing QR code patterns
2. Implement mobile-optimized file upload interface
3. Create submission confirmation and status tracking
4. Implement proper security validations and virus scanning
5. Store submissions in swms_submissions table with audit logging

## Tasks / Subtasks

- [ ] Task 1: Create token-based portal authentication system (AC: 1)
  - [ ] Subtask 1.1: Design token URL structure following check-in pattern: `/swms-portal/[token]`
  - [ ] Subtask 1.2: Create server action to validate tokens against swms_jobs table
  - [ ] Subtask 1.3: Implement token expiration handling (7-day default)
  - [ ] Subtask 1.4: Add token regeneration functionality for admin interface
  - [ ] Subtask 1.5: Create middleware to protect portal routes with token validation

- [ ] Task 2: Build mobile-optimized submission interface (AC: 2)
  - [ ] Subtask 2.1: Create responsive portal layout using Shadcn/ui Card components
  - [ ] Subtask 2.2: Implement file upload component with drag-and-drop support
  - [ ] Subtask 2.3: Add file type validation (PDF, DOC, DOCX, JPG, PNG)
  - [ ] Subtask 2.4: Display job site information and submission requirements
  - [ ] Subtask 2.5: Add progress indicators and upload status feedback
  - [ ] Subtask 2.6: Implement mobile camera integration for document capture

- [ ] Task 3: Create submission confirmation and tracking (AC: 3)
  - [ ] Subtask 3.1: Build submission success page with confirmation number
  - [ ] Subtask 3.2: Implement email confirmation using Edge Function patterns
  - [ ] Subtask 3.3: Create status tracking page with submission history
  - [ ] Subtask 3.4: Add download receipt functionality
  - [ ] Subtask 3.5: Display submission requirements checklist and completion status

- [ ] Task 4: Implement security validations and virus scanning (AC: 4)
  - [ ] Subtask 4.1: Create file validation Edge Function following existing patterns
  - [ ] Subtask 4.2: Implement virus scanning integration with external service
  - [ ] Subtask 4.3: Add file size limits and format validation (10MB max per file)
  - [ ] Subtask 4.4: Create quarantine system for suspicious files
  - [ ] Subtask 4.5: Implement rate limiting to prevent abuse
  - [ ] Subtask 4.6: Add CSRF protection for form submissions

- [ ] Task 5: Store submissions with audit logging (AC: 5)
  - [ ] Subtask 5.1: Create server actions to insert records into swms_submissions table
  - [ ] Subtask 5.2: Store files in Supabase Storage with proper bucket structure
  - [ ] Subtask 5.3: Implement audit logging for all submission events
  - [ ] Subtask 5.4: Add database triggers for status change notifications
  - [ ] Subtask 5.5: Create data retention policies following compliance requirements

- [ ] Task 6: Testing and validation (AC: All)
  - [ ] Subtask 6.1: Write unit tests for token validation and file upload components
  - [ ] Subtask 6.2: Test mobile responsiveness across different devices
  - [ ] Subtask 6.3: Test file upload error scenarios and edge cases
  - [ ] Subtask 6.4: Verify security measures prevent unauthorized access
  - [ ] Subtask 6.5: Test integration with existing swms_submissions table
  - [ ] Subtask 6.6: Performance test with realistic file sizes and volumes

## Dev Notes

### Previous Story Dependencies & Prerequisites
**SWMS Data Structure Status (from Story 1.3):**
- **REQUIRED**: swms_submissions table MUST exist before implementing submission storage
- **Schema**: id (UUID), swms_job_id (UUID FK), contractor_id (UUID FK), document_name (TEXT), file_url (TEXT), status (TEXT), submitted_at, reviewed_at, reviewed_by (UUID), notes (TEXT), created_at, updated_at
- **Implementation**: If swms_submissions table doesn't exist, Task 5 is BLOCKED until Story 1.3 completion
- **Verification**: Check `supabase/migrations/` for SWMS tables migration before proceeding

**Contractors Table Dependency (from Story 1.1):**
- **REQUIRED**: Contractors table must exist for contractor_id foreign key relationship
- **Status**: Should be completed from Story 1.1 contractor-employee hierarchy foundation
- **Integration**: Portal must link submissions to existing contractor records

### Data Models [Source: architecture/tech-stack.md#swms-enhancement-tables]
**SWMS Submissions Table:**
- Table: `swms_submissions` (created in Story 1.3)
- Primary purpose: Store contractor document submissions with full audit trail
- Key relationships: Links to swms_jobs (job assignments) and contractors (company records)
- Status workflow: submitted → under_review → approved/rejected
- File storage: Supabase Storage with signed URLs

**SWMS Jobs Table:**
- Table: `swms_jobs` (created in Story 1.3)
- Purpose: Define SWMS requirements per job site
- Contains: job_site_id, requirements, deadlines, status
- Token generation: Admin creates tokens for contractor access

### Authentication & Security [Source: architecture/security-architecture.md#authentication-authorization]
**Token-Based Security Model:**
- Method: UUID tokens with database validation (no account required)
- Scope: Single submission per token with job site restrictions
- Expiry: 7 days default, configurable by admin
- Validation: UUID lookup against swms_jobs table with active status check
- Pattern: Follow existing check-in token approach from `/check-in` system

**File Storage Security [Source: architecture/security-architecture.md#file-storage-security]:**
- Bucket Structure: `/swms-documents/job-sites/{job_id}/submissions/{contractor_id}/`
- Access Control: RLS + signed URLs with 24-hour expiry
- Encryption: AES-256 at rest (Supabase managed)
- Virus Scanning: Edge Function integration with external service
- File Limits: 10MB max per file, PDF/DOC/DOCX/JPG/PNG formats only

### File Locations [Source: architecture/source-tree.md#public-swms-portal]
**Portal Routes (to be created):**
- **Main Portal**: `src/app/swms-portal/[token]/page.tsx`
- **Upload Interface**: `src/app/swms-portal/[token]/upload/page.tsx`
- **Confirmation**: `src/app/swms-portal/[token]/confirmation/page.tsx`
- **Server Actions**: `src/app/swms-portal/[token]/actions.ts`

**Components (to be created):**
- **Portal Layout**: `src/components/swms/PortalLayout.tsx`
- **File Upload**: `src/components/swms/FileUpload.tsx`
- **Submission Status**: `src/components/swms/SubmissionStatus.tsx`
- **Requirements Checklist**: `src/components/swms/RequirementsChecklist.tsx`

### API Integration Points [Source: architecture/tech-stack.md#api-patterns]
**File Upload Pattern:**
- Follow existing white card processing from `process-white-card` Edge Function
- Use Supabase Storage client for file operations
- Implement progressive upload with status tracking
- Return signed URLs for file access

**Email Integration:**
- Follow existing notification patterns from `notify-builder` Edge Function
- Send confirmation emails to contractor contact_email
- Use existing email templates structure and SMTP configuration
- Include submission receipts and status updates

### Component Specifications [Source: architecture/coding-standards.md#component-guidelines]
**Mobile-First Design Requirements:**
- Use existing responsive patterns from check-in system
- Implement touch-friendly file upload interface
- Support device camera integration for document capture
- Follow existing Shadcn/ui component patterns for consistency

**File Upload Component Specifications:**
- Drag-and-drop support with visual feedback
- Multiple file selection with individual progress tracking
- File type and size validation with user-friendly error messages
- Preview functionality for uploaded documents
- Upload retry mechanism for failed uploads

### RLS Policies Integration [Source: Story 1.3 implementation]
**Portal Access Policies:**
- Token-based contractor access: `contractor_id IN (SELECT id FROM contractors WHERE magic_link_token = current_setting('request.jwt.claims.token', true))`
- Admin full access: `auth.role() = 'authenticated'` for admin management
- Read-only public access for status checking (no sensitive data exposure)

**File Storage Policies:**
- Contractor can upload: Own documents only, linked to their submissions
- Admin can access: All files with full management capabilities
- Audit logging: All file operations logged for compliance

### Integration with Existing Systems
**Check-in System Pattern Reuse:**
- Token URL structure: `/swms-portal/[token]` mirrors `/check-in` pattern
- Geolocation integration: Optional location verification for job site matching
- QR code generation: Admin can generate QR codes for contractor access
- Mobile optimization: Reuse responsive design patterns from check-in interface

**Admin Interface Integration:**
- Token management in existing job sites admin pages
- Submission review interface integrated into SWMS management
- Notification integration with existing alert systems
- Dashboard metrics integration for compliance tracking

### Performance Requirements [Source: architecture/tech-stack.md#performance-requirements]
**File Upload Performance:**
- Support up to 10MB documents with progress tracking
- Multiple concurrent uploads with queue management
- Resume capability for interrupted uploads
- Compression for image files to optimize storage

**Portal Performance:**
- Page load: < 2s on mobile networks
- File validation: < 1s for standard document sizes
- Status updates: Real-time via websockets or polling
- Offline capability: Queue uploads when network unavailable

### Testing

**Testing Framework Requirements:**
- **Location**: Portal tests in `src/app/swms-portal/__tests__/` directory
- **Framework**: Jest + React Testing Library for components, Playwright for E2E
- **File Upload Testing**: Mock file uploads and test validation logic
- **Security Testing**: Test token validation, unauthorized access prevention

**Required Test Categories:**
1. **Token Validation Tests**: Valid/invalid/expired token scenarios
2. **File Upload Tests**: Various file types, sizes, error conditions
3. **Mobile Responsiveness**: Test across different device sizes
4. **Security Tests**: CSRF protection, rate limiting, file validation
5. **Integration Tests**: Submission storage, email notifications, audit logging

**Test Data Requirements:**
- Mock contractor records with various status states
- Test files of different formats and sizes (including oversized)
- Invalid token scenarios for security testing
- Mobile device simulation for responsive testing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-03 | 1.0 | Initial story creation with complete technical context | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*Agent model and version will be recorded here*

### Debug Log References
*Debug logs and traces will be referenced here*

### Completion Notes List
*Implementation notes and issues will be documented here*

### File List
*All created/modified files will be listed here*

## QA Results
*This section will be populated by the QA agent after story completion*